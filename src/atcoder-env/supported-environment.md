<!-- -*- coding:utf-8-unix -*- -->

# 本章で想定している環境

## 用語

まずは用語を整理します。本章で用いる用語には以下のものがあります。

- **ユーザプログラム**
  - 選手が提出したプログラムのこと
- **ジャッジサーバ**
  - オンラインジャッジを行うサーバのこと。ジャッジサーバはユーザプログラムをコンパイルし、実行する
- **実行ファイル**（executable file）
  - マシンコードを含み、メモリに読み込んで実行できる形式のファイルのこと。バイナリファイルとも呼ばれる。プログラムのソースコードをコンパイル、リンクすることで生成される
- **Rustコンパイラ**（`rustc`）
  - `rustc`コマンドのこと。Rustプログラムのコンパイルとリンクを行う
  - なお`rustc`にはリンカの機能は含まれていないため、`rustc`はリンク時に外部ツールを呼び出すようになっている。ターゲットがLinux Gnu ABIの場合は`gcc`経由で`ld`を呼び出す
- **Cargo**（`cargo`）
  - Rustのビルドツール兼パッケージマネージャの`cargo`コマンドのこと
  - なおカーゴは貨車の意味
- **Rustツールチェイン**
  - Rustコンパイラ、Cargo、Rustの標準ライブラリなどをバージョンごとにまとめたもの
- **Rustup**（`rustup`）
  - Rustツールチェインの管理ツールである`rustup`コマンドのこと
  - 指定したバージョンのRustツールチェインを簡単にインストールできるだけでなく、複数バージョンのツールチェインも管理できる
  - `rustc`や`cargo`と同様、Rustプロジェクトチームにより公式にサポートされている
- **クレート（crate）**
  - クレートは貨物などを入れる木箱の意味
  - Rustにはlib crateとbin crateがある
  - lib crateはRustで書かれたライブラリのこと。コンパイルするとrlibファイルが作られる
  - bin crateはRustで書かれたアプリケーションのこと。コンパイル、リンクすると実行ファイルが作られる
  - 世界中のRustユーザが作成した無数のクレートが、セントラルリポジトリの[crates.io](https://crates.io)で公開されている
  - **本章にはbin crateは登場しないので、単にクレートと呼んだ場合はlib crateを指すことにする**
- **Cargoパッケージ**
  - Cargoの1単位。Rustのソースコードや`Cargo.toml`などの設定ファイルで構成される
  - 1つのCargoパッケージには単一または複数のクレートが含まれる


## 想定する環境

本章ではAtCoderのジャッジサーバ環境として、以下のものを想定しています。

- Ubuntu 18.04 LTS x86_64
- ユーザプログラムは何らかのコンテナ内で実行される
  - インターネットなどのネットワークアクセスは不可
  - 物理メモリ、ディスクファイルサイズ、プロセス数などの制限がある
  - ユーザプログラムが出力したファイルは、テストケースを1つ実行するごとに削除される
- プログラミング言語ごとにファイルシステムが分かれているわけではない
  - たとえば提出言語としてBashやPythonを選択したときに、他の言語のコンパイラを実行するようなスクリプトを提出、実行できる
  - （このようなプログラムを提出することは推奨はされないだろうが、現状は可能となっている）
- ユーザプログラムをコンパイル、実行するLinuxユーザは、単一のユーザなのか、複数のユーザなのかは不明


## 一般的なRustプログラム開発環境との違い

一般的なRustプログラムの開発では`rustup`をデフォルト設定で使うことで、いまログインしているLinuxユーザ専用の場所にツールチェインをインストールします。またユーザプログラムのビルドには`cargo`を使い、そのプログラムが依存しているクレートのソースファイルを自動的にダウンロードし、ユーザプログラムと共にコンパイルします。

ジャッジサーバではこの方法はあまりうまくいきません。

- Linuxユーザを複数使用している場合に、ユーザごとにツールチェインをインストールすることになる
- ツールチェインのファイルパーミッションがそのままだと、悪意のあるユーザプログラムがツールチェインを改変してしまうかもしれない
- クレートのソースファイルのダウンロードを`cargo`に任せると、選手が使用できるクレートを制限できない
- ジャッジの際に毎回クレートがコンパイルされることになり非効率

そこで本章では以下のようにします。

- Rustツールチェインを、ジャッジサーバ上の全Linuxユーザがread-onlyでアクセスできる場所にインストールする
- 選手が使用できるクレートを事前に選定し、コンパイルしておく
  - コンパイルしてできた`rlib`ファイルをジャッジサーバ上の全Linuxユーザがread-onlyでアクセスできる場所に保存する
- ジャッジの際にはユーザプログラムのコンパイルに`cargo`を介さずに`rustc`を直接実行することで、クレートが毎回コンパイルされることを防ぐ

Rustツールチェインや`rlib`ファイルは`/usr/local/lib/rust`ディレクトリ配下に置きます。

なお、選手が使用するクレートを制限することは、本章で用いる方法の他に、[`cargo-vendor`][cargo-vendor-crate]という`cargo`の拡張コマンドを使うことでも実現できます。しかしその方法ではジャッジの際にクレートが毎回コンパイルされることは防げません。

[cargo-vendor-crate]: https://crates.io/crates/cargo-vendor
